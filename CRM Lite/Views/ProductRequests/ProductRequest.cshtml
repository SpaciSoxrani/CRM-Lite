
@{
    ViewData["Name"] = "ProductRequest";
}

@model CRM.Data.Models.ProductRequest
@{
    var needToAnswer = Model.IsStarted && Model.VendorsRequests.Any(v => !v.IsAccepted && v.Responsible.Login.ToLower() == User.Identity.Name.ToLower());
    var needToAnswerFromDepartment = Model.IsStarted && Model.VendorsRequests.Any(v => !v.IsProductCorrect && !v.IsAccepted && v.Responsible.Login.ToLower() == User.Identity.Name.ToLower());
}

<div class="animated fadeIn">
    <div id="request" class="card">
        <div class="card-body">
            <div class="col">
                <div class="col">
                    <div class="row justify-content-between" style="padding-bottom: 0;">
                        <div class="col">
                            <a href="/Deals/Deal/@Model.DealId" class="font-weight-bold" target="_blank">Ссылка на сделку</a>
                        </div>
                        <div class="col d-flex justify-content-end">
                            <p id="creation-date" style="padding-right: 15px;">@(Model.CreationDate.HasValue ? Model.CreationDate.Value.ToString("dd.MM.yyyy HH:mm") : "")</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group ">
                                <label class="switch switch-3d switch-primary">
                                    <input id="repeat-deal"
                                           type="checkbox" class="switch-input" />
                                    <span class="switch-label"></span>
                                    <span class="switch-handle"></span>
                                </label>
                                <label class="form-check-inline" for="repeat-deal">Повторное обращение</label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group col-md-4">
                            <label for="adm-contact">Административный контакт заказчика</label>
                            <br />
                            <select @(Model.IsStarted ? "disabled" : "") class="form-control" style="width:100%; height:2.5em;" id="adm-contact"></select>
                        </div>

                        <div class="form-group col-md-4">
                            <label for="tech-contact">Технический контакт заказчика</label>
                            <br />
                            <select @(Model.IsStarted ? "disabled" : "") class="form-control" style="width:100%; height:2.5em;" id="tech-contact"></select>
                        </div>

                        <div class="form-group col-md-4">
                            <label for="another-responsible">Добавить участников</label>
                            <br />
                            <select @(Model.IsStarted ? "disabled" : "") class="form-control" style="width:100%; height:2.5em;" id="another-responsible" multiple="multiple"></select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col" id="vendors-block">
                            @if (Model.VendorsRequests.Count == 0)
                            {
                                <div class="row">
                                    <div class="form-group col-md-3">
                                        <label for="vendor0">Вендор</label>
                                        <br />
                                        <select @(Model.IsStarted ? "disabled" : "") class="form-control" style="width: 100%; height: 2.5em;" id="vendor0"></select>
                                    </div>

                                    <div class="form-group col-md-3">
                                        <label for="responsible-product0">Ответственный продакт</label>
                                        <br />
                                        <select @(Model.IsStarted ? "disabled" : "") class="form-control" style="width: 100%; height: 2.5em;" id="responsible-product0"></select>
                                    </div>
                                </div>
                            }
                            else
                            {
                                for (var i = 0; i < Model.VendorsRequests.Count; i++)
                                {
                                    <div class="row">
                                        @if (string.IsNullOrWhiteSpace(Model.VendorsRequests[i].Comment))
                                        {
                                            <div class="form-group col-md-3">
                                                <label for="@("vendor" + i)">Вендор</label>
                                                <br />
                                                <select @(Model.IsStarted ? "disabled" : "") class="form-control" style="width: 100%; height: 2.5em;" id="@("vendor" + i)"></select>
                                            </div>
                                        }

                                        <div class="form-group col-md-3">
                                            <label for="@("responsible-product" + i)">Ответственный продакт</label>
                                            <br />
                                            <select @(Model.IsStarted ? "disabled" : "") class="form-control" style="width: 100%; height: 2.5em;" id="@("responsible-product" + i)"></select>
                                        </div>

                                        @if (!string.IsNullOrWhiteSpace(Model.VendorsRequests[i].Comment))
                                        {
                                            <div class="form-group col-md-3">
                                                <label for="@("comment" + i)">Комментарий</label>
                                                <br />
                                                <textarea disabled class="form-control" style="width: 100%; height: 2.5em;" id="@("comment" + i)"></textarea>
                                            </div>
                                        }

                                        @if (Model.VendorsRequests[i].IsAccepted)
                                        {
                                            <div id="answer-date" class="form-group col">
                                                <label for="answer-date-value">
                                                    Дата принятия
                                                </label>
                                                <br />
                                                <input disabled type="date" value="@(Model.VendorsRequests[i].AnswerDate.HasValue ? Model.VendorsRequests[i].AnswerDate.Value.ToString("yyyy-MM-dd") : "")" id="answer-date-value" style="width: 100%; height: 2.5em;"
                                                       class="form-control" />
                                            </div>

                                            <div id="execution-date" class="form-group col">
                                                <label for="execution-date-value">
                                                    Планируемая дата исполнения
                                                </label>
                                                <br />
                                                <input disabled type="date" value="@(Model.VendorsRequests[i].ExecutionDate.HasValue ? Model.VendorsRequests[i].ExecutionDate.Value.ToString("yyyy-MM-dd") : "")" id="execution-date-value" style="width: 100%; height: 2.5em;"
                                                       class="form-control" />
                                            </div>

                                            @if (!Model.VendorsRequests[i].IsFinished)
                                            {
                                                <div id="execute-block" class="form-group col">
                                                    <label></label>
                                                    <button class="btn download-btn mt-2" style="background: #ff6a00;" type="button" onclick="CompleteRequest();">Выполнена</button>
                                                </div>
                                            }
                                            else
                                            {
                                                <div id="fact-execution-date" class="form-group col">
                                                    <label for="fact-execution-date-value">
                                                        Фактическая дата исполнения
                                                    </label>
                                                    <br />
                                                    <input disabled type="date" value="@(Model.VendorsRequests[i].FinishDate.HasValue ? Model.VendorsRequests[i].FinishDate.Value.ToString("yyyy-MM-dd") : "")" id="fact-execution-date-value" style="width: 100%; height: 2.5em;"
                                                           class="form-control" />
                                                </div>
                                            }
                                        }
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    @if (!Model.IsStarted)
                    {
                        <div id="add-vendor" class="d-none pl-2">
                            <a onclick="AddVendor()" class="btn download-btn" style="width: fit-content; color: white;">+</a>
                        </div>
                    }

                    <div class="form-group" id="quests-div" style="margin-left: -15px;margin-right: -15px;">
                        <div class="col">
                            <div class="row">
                                <div class="col">Задачи на продуктирование</div>
                                <div class="col d-flex justify-content-end" id="first-date">
                                    @(Model.Quests.Count > 0 ?
                                        Model.Quests[0].ChangedDate.HasValue ? Model.Quests[0].ChangedDate.Value.ToString("dd.MM.yyyy HH:mm") : ""
                                        : "")
                                </div>
                            </div>
                            <div class="input-group col-12">
                                <textarea @(Model.IsStarted ? "disabled" : "") style="height: 14rem;" class="form-control" id="quests">@(Model.Quests.Count > 0 ? Model.Quests[0].Quest.Trim() : "")</textarea>
                            </div>
                        </div>
                    </div>

                    <br />

                    <div id="decision-of-department-head" class="form-group @(needToAnswerFromDepartment ? "" : "d-none")">
                        <div class="row" style="align-items:flex-end; align-content:flex-end;">
                            <div class="col-2" style="margin-bottom:6px;">
                                <input type="button" id="show-answer-block" onclick="ShowAnswerBlock()" class="btn btn-primary" value="Назначить на себя">
                            </div>
                            <div class="col-2" style="margin-bottom:6px;">
                                <input type="button" id="show-product-swipe-block" onclick="ShowSwipeProductBlock()" class="btn btn-primary" value="Назначить ответственного продакта">
                            </div>
                        </div>
                    </div>

                    <div id="swipe-product" class="form-group d-none">
                        <div class="row" style="align-items:flex-end; align-content:flex-end;">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="new-responsible-product">Ответственный продакт</label>
                                    <br />
                                    <select class="form-control" style="width:100%; height:2.5em;" id="new-responsible-product"></select>
                                </div>
                                <div class="form-group">
                                    <label for="new-comment" class="control-label col-xs-4">Комментарий</label>
                                    <div class="input-group col-xs-7">
                                        <textarea class="form-control" style="height:14rem;" id="new-comment"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="col" style="margin-bottom:6px;">
                                <input type="button" id="swipe" onclick="SwipeProductManager();" class="btn btn-primary" value="Назначить">
                            </div>
                        </div>
                    </div>

                    <div id="answer" class="form-group @(!needToAnswerFromDepartment && needToAnswer ? "" : "d-none")">
                        <div class="row" style="align-items:flex-end; align-content:flex-end;">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="answer-execution-date">
                                        Дата исполнения
                                    </label>
                                    <br />
                                    <input id="answer-execution-date" type="text" style="width:100%; height:2.5em;"
                                           class="datepicker-here form-control" placeholder="дд.мм.гггг" />
                                </div>
                            </div>
                            <div class="col mb-1">
                                <input type="button" id="send-answer" onclick="SendAnswer();" class="btn btn-primary" value="Принять заявку">
                            </div>
                        </div>
                    </div>

                    <div id="add-buttons" style="display:block;">
                        <div class="row justify-content-end p-2">

                            <div id="show-pm-button" class="form-actions text-center @(Model.IsStarted ? "" : "d-none")" style="margin:7px;">
                                <input type="button" onclick="ShowPmFields()" class="btn btn-primary" value="Добавить отв. продакта">
                            </div>

                            <div class="form-actions text-center  @(Model.IsStarted ? "d-none" : "")" style="margin:7px;">
                                <input onclick="EditRequest(false)" type="button" class="btn download-btn" value="Сохранить">
                            </div>

                            <div class="form-actions text-center  @(Model.IsStarted ? "d-none" : "")" style="margin:7px;">
                                <input onclick="EditRequest(true)" type="button" class="btn download-btn" style="background:#ff6a00" value="Старт заявки">
                            </div>

                            <div id="save-new-pm" class="form-actions text-center d-none" style="margin:7px;">
                                <input type="button" onclick="SaveNewPm();" class="btn btn-primary" value="Сохранить">
                            </div>
                        </div>
                    </div>
                    <br />

                    <div id="pm-fields" class="col d-none">
                        <div class="col">
                            <div class="row">
                                <div class="form-group col-md-4">
                                    <label for="add-pm">Ответственный продакт</label>
                                    <br />
                                    <select class="form-control" style="width:100%; height:2.5em;" id="add-pm"></select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="add-comment" class="control-label col-xs-4">Комментарий</label>
                                <div class="input-group col-xs-7">
                                    <textarea class="form-control" style="height:14rem;" id="add-comment"></textarea>
                                </div>
                            </div>

                            <div class="form-actions text-center">
                                <input type="button" onclick="HidePmFields()" class="btn btn-secondary" value="Отмена">
                                <input id="save-add-mp" type="button" onclick="AddPm()" class="btn btn-primary" value="Добавить">
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script src="~/lib/jquery-loading-overlay-1.6.0/loadingoverlay.js" type='text/javascript'></script>
    <script src="~/lib/select2/select2.min.js"></script>
    <script type="text/javascript" src="~/lib/datepicker/js/datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.3/signalr.min.js">
    </script>

    <script>
        var productRequest = @Html.Raw(Json.Serialize(Model));

        $("select").select2({
            placeholder: "Выберите элемент",
            allowClear: true
        });
    </script>

    <script>
        var answerExecutionDatePicker = $('#answer-execution-date').datepicker({
            todayButton: new Date(),
            autoClose: true,
            dateFormat: 'yyyy-mm-dd',
            minDate: new Date()
        });

        var answerExecutionDatePickerData = answerExecutionDatePicker.datepicker().data('datepicker');

        $('.datepicker-here').each(function () {
            $(this).keypress(function () {
                return false;
            });
            $(this).attr("autocomplete", "off");
        });
    </script>

    <script src="~/js/ProductRequest/loadInfo.js" asp-append-version="true"></script>
    <script src="~/js/ProductRequest/sendAnswer.js" asp-append-version="true"></script>
    <script src="~/js/ProductRequest/сompleteRequest.js" asp-append-version="true"></script>
    <script src="~/js/ProductRequest/editPm.js" asp-append-version="true"></script>
    <script src="~/js/ProductRequest/addVendor.js" asp-append-version="true"></script>
    <script src="~/js/ProductRequest/swipeProductManager.js" asp-append-version="true"></script>
    <script src="~/js/ProductRequest/editRequest.js" asp-append-version="true"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

}

@section Styles {
    <link href="~/lib/select2/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/lib/datepicker/css/datepicker.min.css" type="text/css" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta charset="UTF-8" />

    <style>
        /* todo: перенести стили в .scss */


        .required-field-group-highlighted {
            outline: 2px solid red;
            padding: 2px;
        }

        .form-control:disabled, .form-control[readonly],
        input[type="checkbox"]:disabled + span + span.switch-handle {
            background-color: #eee !important;
        }

        #form-summary select {
            width: 100%
        }
            /* This is to remove the arrow of select element in IE */
            #form-summary select::-ms-expand {
                display: none;
            }

        #form-summary select {
            -webkit-appearance: none;
            /*appearance: none;*/
        }

        .download-btn {
            text-align: center;
            font-size: 13px;
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            padding: 3px 6px;
            background: #20a8d8;
            display: block;
            width: 120px;
            border-radius: 3px;
            box-shadow: 0 0 0 1px rgba(0,0,0,.2), 0 1px 2px rgba(0,0,0,.2), inset 0 1px 2px rgba(255,255,255,.7);
            cursor: pointer !important;
        }

        .colorStar {
            color: red;
        }
    </style>
}
